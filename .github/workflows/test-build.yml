name: Test Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        flutter-version: ['3.24.0', '3.22.0']
        java-version: ['17', '11']
        include:
          - flutter-version: '3.24.0'
            java-version: '17'
            build-type: 'standard'
          - flutter-version: '3.24.0'
            java-version: '17'
            build-type: 'compat'
          - flutter-version: '3.22.0'
            java-version: '11'
            build-type: 'standard'
    
    name: Flutter ${{ matrix.flutter-version }} + Java ${{ matrix.java-version }} (${{ matrix.build-type }})
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Java ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java-version }}
        cache: 'gradle'
        
    - name: 设置 Flutter ${{ matrix.flutter-version }}
      uses: subosito/flutter-action@v3
      with:
        flutter-version: ${{ matrix.flutter-version }}
        channel: 'stable'
        cache: true
        
    - name: 环境信息
      run: |
        echo "=== 环境信息 ==="
        echo "Flutter: $(flutter --version | head -1)"
        echo "Dart: $(dart --version)"
        echo "Java: $(java -version 2>&1 | head -1)"
        echo "Gradle: $(cd android && ./gradlew --version | grep Gradle | head -1)"
        
    - name: 准备构建
      run: |
        echo "=== 准备构建 ==="
        flutter clean
        flutter pub get
        
        # 如果是兼容模式，应用特殊设置
        if [ "${{ matrix.build-type }}" = "compat" ]; then
          echo "应用兼容模式设置..."
          # 这里可以添加兼容模式的特殊处理
        fi
        
    - name: 执行构建
      run: |
        echo "=== 执行构建 (${{ matrix.build-type }}) ==="
        
        case "${{ matrix.build-type }}" in
          "standard")
            flutter build apk --debug
            ;;
          "compat")
            flutter build apk --debug --no-sound-null-safety || \
            flutter build apk --debug --no-tree-shake-icons
            ;;
        esac
        
    - name: 检查结果
      run: |
        echo "=== 检查结果 ==="
        APK_COUNT=$(find . -name "*.apk" -type f | wc -l)
        echo "APK 文件数量: $APK_COUNT"
        
        if [ $APK_COUNT -gt 0 ]; then
          echo "✅ 构建成功"
          find . -name "*.apk" -type f -exec ls -la {} \;
        else
          echo "❌ 构建失败"
          exit 1
        fi
        
    - name: 上传测试结果
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-build-${{ matrix.flutter-version }}-${{ matrix.java-version }}-${{ matrix.build-type }}
        path: |
          **/*.apk
          android/app/build/logs/
        retention-days: 7
        if-no-files-found: warn