name: CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  standard-build:
    name: Standard Build
    runs-on: ubuntu-latest
    env:
      ACTUAL_PLATFORM_VERSION: 'android-35'
      ACTUAL_BUILD_TOOLS_VERSION: '35.0.0'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: å®‰è£… Android SDK åŸºç¡€ç»„ä»¶
        run: |
          # ä¸‹è½½å¹¶å®‰è£… Android SDK å‘½ä»¤è¡Œå·¥å…·
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mkdir -p $PWD/android-sdk/cmdline-tools/latest
          mv cmdline-tools/* $PWD/android-sdk/cmdline-tools/latest/
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "ANDROID_HOME=$PWD/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$PWD/android-sdk" >> $GITHUB_ENV
          echo "$PWD/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH

      - name: é…ç½® Android SDK è®¸å¯è¯
        run: |
          # å®‰è£…å¿…è¦çš„å·¥å…·
          sudo apt-get update && sudo apt-get install -y expect || true
          
          # æ£€æŸ¥è®¸å¯è¯è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ -f ".github/scripts/bypass-licenses.sh" ]; then
            chmod +x .github/scripts/bypass-licenses.sh
            bash .github/scripts/bypass-licenses.sh "$PWD/android-sdk"
          else
            echo "âš ï¸ è­¦å‘Š: bypass-licenses.sh è„šæœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤è®¸å¯è¯é…ç½®"
            mkdir -p "$ANDROID_HOME/licenses"
            echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_HOME/licenses/android-sdk-license"
            echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
            echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > "$ANDROID_HOME/licenses/android-sdk-license"
          fi
          
          # é¢å¤–çš„ç¯å¢ƒå˜é‡è®¾ç½®
          echo "COMPILE_SDK_VERSION=35" >> $GITHUB_ENV
          echo "BUILD_TOOLS_VERSION=35.0.0" >> $GITHUB_ENV

      - name: å®‰è£… Android SDK ç»„ä»¶
        run: |
          # ä½¿ç”¨å¼ºåˆ¶å®‰è£…è„šæœ¬
          echo "ğŸš€ å¼€å§‹å®‰è£… Android SDK ç»„ä»¶..."
          
          # æ£€æŸ¥å®‰è£…è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ -f ".github/scripts/install-sdk-components-force.sh" ]; then
            chmod +x .github/scripts/install-sdk-components-force.sh
            bash .github/scripts/install-sdk-components-force.sh "platforms;android-35 build-tools;35.0.0"
          else
            echo "âš ï¸ è­¦å‘Š: install-sdk-components-force.sh è„šæœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨ sdkmanager ç›´æ¥å®‰è£…"
            sdkmanager "platforms;android-35" "build-tools;35.0.0" || {
              echo "âŒ SDKç»„ä»¶å®‰è£…å¤±è´¥ï¼Œå°è¯•é™çº§ç‰ˆæœ¬..."
              sdkmanager "platforms;android-34" "build-tools;34.0.0"
            }
          fi
          
          echo "ğŸ“Š å®‰è£…å®Œæˆåçš„ç›®å½•ç»“æ„:"
          ls -la $ANDROID_HOME/platforms/ $ANDROID_HOME/build-tools/ || {
            echo "âŒ å¹³å°æˆ–æ„å»ºå·¥å…·ç›®å½•ä¸å­˜åœ¨"
            exit 1
          }
          
          echo "ğŸ” æ£€æŸ¥å·²å®‰è£…ç»„ä»¶:"
          sdkmanager --list_installed || echo "æ— æ³•åˆ—å‡ºå·²å®‰è£…ç»„ä»¶"

      - name: éªŒè¯ Android SDK å®‰è£…
        run: |
          echo "ğŸ” éªŒè¯ Android SDK å®‰è£…..."
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          
          # æ£€æŸ¥å¹³å°å’Œæ„å»ºå·¥å…·æ˜¯å¦å­˜åœ¨ï¼ˆåˆå¹¶é‡å¤æ£€æŸ¥ï¼‰
          ls -la $ANDROID_HOME/platforms/ $ANDROID_HOME/build-tools/ || {
            echo "âŒ å¹³å°æˆ–æ„å»ºå·¥å…·ç›®å½•ä¸å­˜åœ¨"
            exit 1
          }
          
          # æ£€æŸ¥ android-35 å¹³å°ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å°è¯•ä½¿ç”¨ android-34
          if [ -d "$ANDROID_HOME/platforms/android-35" ]; then
            echo "âœ… android-35 å¹³å°å­˜åœ¨"
            export SDK_PLATFORM="android-35"
          elif [ -d "$ANDROID_HOME/platforms/android-34" ]; then
            echo "âš ï¸ ä½¿ç”¨ android-34 å¹³å°ä½œä¸ºåå¤‡"
            export SDK_PLATFORM="android-34"
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„ Android SDK å¹³å°"
            exit 1
          fi
          
          # æ£€æŸ¥ build-tools 35.0.0ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å°è¯•ä½¿ç”¨ 34.0.0
          if [ -d "$ANDROID_HOME/build-tools/35.0.0" ]; then
            echo "âœ… build-tools 35.0.0 å­˜åœ¨"
            export BUILD_TOOLS="35.0.0"
          elif [ -d "$ANDROID_HOME/build-tools/34.0.0" ]; then
            echo "âš ï¸ ä½¿ç”¨ build-tools 34.0.0 ä½œä¸ºåå¤‡"
            export BUILD_TOOLS="34.0.0"
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„æ„å»ºå·¥å…·"
            exit 1
          fi
          
          # ç”Ÿæˆæ­£ç¡®çš„ local.properties æ–‡ä»¶
          cat > android/local.properties << EOF
          sdk.dir=$ANDROID_HOME
          flutter.sdk=$FLUTTER_ROOT
          flutter.buildMode=debug
          flutter.versionName=1.0.0
          flutter.versionCode=1
          EOF

          echo "ğŸ“„ ç”Ÿæˆçš„ local.properties å†…å®¹:"
          cat android/local.properties

          # è®¾ç½® Flutter ä½¿ç”¨çš„ Android SDK ç¯å¢ƒå˜é‡
          echo "FLUTTER_ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ACTUAL_PLATFORM_VERSION=$SDK_PLATFORM" >> $GITHUB_ENV
          echo "ACTUAL_BUILD_TOOLS_VERSION=$BUILD_TOOLS" >> $GITHUB_ENV
          
          # éªŒè¯ sdkmanager èƒ½æ‰¾åˆ°ç»„ä»¶
          sdkmanager --list_installed | grep -E "(platforms|build-tools)" || echo "æ— æ³•åˆ—å‡ºå·²å®‰è£…ç»„ä»¶"

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true

      - name: æ„å»º APK (Debug)
        run: |
          echo "å¼€å§‹æ„å»º APK..."
          echo "å½“å‰ ANDROID_HOME: $ANDROID_HOME"
          echo "å½“å‰ FLUTTER_ANDROID_SDK_ROOT: $FLUTTER_ANDROID_SDK_ROOT"
          echo "å®é™…ä½¿ç”¨å¹³å°ç‰ˆæœ¬: $ACTUAL_PLATFORM_VERSION"
          echo "å®é™…ä½¿ç”¨æ„å»ºå·¥å…·ç‰ˆæœ¬: $ACTUAL_BUILD_TOOLS_VERSION"
          
          # éªŒè¯ Flutter èƒ½æ‰¾åˆ° Android SDK
          flutter doctor -v
          
          # è®¾ç½® Gradle ç”¨æˆ·ä¸»ç›®å½•ä»¥é¿å…æƒé™é—®é¢˜
          export GRADLE_USER_HOME=$PWD/.gradle
          
          flutter clean
          flutter pub get
          
          # å°è¯•æ„å»ºï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨è¯¦ç»†ä¿¡æ¯è°ƒè¯•
          flutter build apk --debug --verbose || {
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œå°è¯•è°ƒè¯•..."
            echo "Android SDK å†…å®¹:"
            find $ANDROID_HOME -name "*android*" -type d | head -10
            echo "Gradle é…ç½®:"
            cat android/local.properties
            echo "ç¯å¢ƒå˜é‡:"
            env | grep -E "(ANDROID|FLUTTER|GRADLE)"
            exit 1
          }

      - name: ä¸Šä¼  APK ä¸º Artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: standard-build-${{ github.run_number }}
          path: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: åˆ›å»º Release
        if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: Build ${{ github.run_number }}
          body: |
            ## è‡ªåŠ¨æ„å»ºçš„ Debug ç‰ˆæœ¬
            
            **æ„å»ºä¿¡æ¯ï¼š**
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
            - Run: #${{ github.run_number }}
            - å¹³å°ç‰ˆæœ¬: ${{ env.ACTUAL_PLATFORM_VERSION || 'android-35' }}
            - æ„å»ºå·¥å…·ç‰ˆæœ¬: ${{ env.ACTUAL_BUILD_TOOLS_VERSION || '35.0.0' }}
            
            **APK è¯´æ˜ï¼š**
            æ­¤æ„å»ºå·²å¯ç”¨ ABI åˆ†å‰²ï¼ŒåŒ…å«ä»¥ä¸‹æ¶æ„çš„ APKï¼š
            - `app-arm64-v8a-debug.apk`: é€‚ç”¨äº 64 ä½ ARM è®¾å¤‡ï¼ˆç°ä»£æ‰‹æœºï¼Œæ¨èï¼‰
            - `app-armeabi-v7a-debug.apk`: é€‚ç”¨äº 32 ä½ ARM è®¾å¤‡
            - `app-universal-debug.apk`: é€šç”¨ç‰ˆæœ¬ï¼ˆå…¼å®¹æ‰€æœ‰æ¶æ„ï¼Œä½“ç§¯è¾ƒå¤§ï¼‰
            
            è¯·æ ¹æ®æ‚¨çš„è®¾å¤‡é€‰æ‹©å¯¹åº”æ¶æ„çš„ APK ä¸‹è½½å®‰è£…ã€‚
          files: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/debug/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}