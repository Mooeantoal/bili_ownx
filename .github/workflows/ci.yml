name: Unified CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write
  actions: read
  checks: write
  packages: write
  pull-requests: write
  statuses: write

jobs:
  standard-build:
    name: Standard Build
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: 设置 Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      # === 新增Java环境验证步骤 ===
      - name: 验证 Java 环境
        run: |
          echo "JAVA_HOME: $JAVA_HOME"
          echo "JAVA_HOME_17_X64: $JAVA_HOME_17_X64"
          java -version
          javac -version

      - name: 设置 Android SDK
        uses: android-actions/setup-android@v3

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.0'
          channel: 'stable'
          cache: true

      - name: 构建 APK (Debug)
        run: |
          echo "开始构建 APK..."
          flutter clean
          flutter pub get
          flutter build apk --debug --verbose --split-per-abi --no-tree-shake-icons

      - name: 上传 APK 为 Artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: standard-build-${{ github.run_number }}
          path: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: 创建 Release
        if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: Build ${{ github.run_number }}
          body: |
            ## 自动构建的 Debug 版本
            
            **构建信息：**
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
            - Run: #${{ github.run_number }}
            
            **APK 说明：**
            此构建已启用 ABI 分割，包含以下架构的 APK：
            - `app-arm64-v8a-debug.apk`: 适用于 64 位 ARM 设备（现代手机，推荐）
            - `app-armeabi-v7a-debug.apk`: 适用于 32 位 ARM 设备
            
            请根据您的设备选择对应架构的 APK 下载安装。
          files: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/debug/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
