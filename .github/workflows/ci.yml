name: CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write
  actions: read

jobs:
  standard-build:
    name: Standard Build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      TARGET_SDK_VERSION: '36'
      FALLBACK_SDK_VERSION: '35'
      BUILD_TOOLS_VERSION: '36.0.0'
      FALLBACK_BUILD_TOOLS_VERSION: '35.0.0'
      JAVA_VERSION: '11'
      # Dynamic variables set during the job
      ACTUAL_PLATFORM_VERSION: ''
      COMPILE_SDK_VERSION: ''
      ACTUAL_BUILD_TOOLS_VERSION: ''
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
          cache-dependency-path: |
            android/build.gradle
            android/app/build.gradle.kts

      - name: å®‰è£… Android SDK åŸºç¡€ç»„ä»¶
        timeout-minutes: 10
        run: |
          set -e
          
          # ä¸‹è½½å¹¶å®‰è£… Android SDK å‘½ä»¤è¡Œå·¥å…·
          TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
          FALLBACK_TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip"
          wget -q --tries=3 --timeout=30 "$TOOLS_URL" || {
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨URL..."
            wget -q --tries=3 --timeout=30 "$FALLBACK_TOOLS_URL"
          }
          
          unzip -q commandlinetools-linux-*.zip
          mkdir -p $PWD/android-sdk/cmdline-tools/latest
          mv cmdline-tools/* $PWD/android-sdk/cmdline-tools/latest/
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "ANDROID_HOME=$PWD/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$PWD/android-sdk" >> $GITHUB_ENV
          echo "$PWD/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          
          # éªŒè¯å®‰è£…
          if [ ! -f "$PWD/android-sdk/cmdline-tools/latest/bin/sdkmanager" ]; then
            echo "âŒ SDKå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… SDKåŸºç¡€ç»„ä»¶å®‰è£…å®Œæˆ"

      - name: é…ç½® Android SDK è®¸å¯è¯
        timeout-minutes: 5
        run: |
          set -e
          
          # ç›´æ¥ä½¿ç”¨é»˜è®¤è®¸å¯è¯é…ç½®ï¼ˆæ›´å¯é ï¼‰
          mkdir -p "$ANDROID_HOME/licenses"
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_HOME/licenses/android-sdk-license"
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > "$ANDROID_HOME/licenses/android-sdk-sdk-preview-license"
          
          # è‡ªåŠ¨æ¥å—æ‰€æœ‰è®¸å¯è¯
          yes | $PWD/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses 2>&1 | grep -v "Warning" || true
          
          # éªŒè¯è®¸å¯è¯æ–‡ä»¶
          if [ ! -f "$ANDROID_HOME/licenses/android-sdk-license" ]; then
            echo "âŒ è®¸å¯è¯é…ç½®å¤±è´¥"
            exit 1
          fi
          echo "âœ… è®¸å¯è¯é…ç½®å®Œæˆ"

      - name: å®‰è£…å’Œé…ç½® Android SDK
        timeout-minutes: 15
        run: |
          set -e
          echo "ğŸš€ å¼€å§‹å®‰è£… Android SDK ç»„ä»¶..."
          
          # æ¸…ç†ç›®æ ‡ç‰ˆæœ¬
          rm -rf "$ANDROID_HOME/platforms/android-$TARGET_SDK_VERSION"*
          
          # å¢å¼ºçš„å®‰è£…é€»è¾‘
          SDK_SUCCESS=false
          
          # å°è¯•å®‰è£…ä¸»è¦ç‰ˆæœ¬
          if sdkmanager "platforms;android-$TARGET_SDK_VERSION" "build-tools;$BUILD_TOOLS_VERSION"; then
            echo "âœ… ä¸»è¦ç‰ˆæœ¬å®‰è£…æˆåŠŸ"
            SDK_SUCCESS=true
          else
            echo "âš ï¸ ä¸»è¦ç‰ˆæœ¬å®‰è£…å¤±è´¥ï¼Œå°è¯•åå¤‡ç‰ˆæœ¬..."
            if sdkmanager "platforms;android-$FALLBACK_SDK_VERSION" "build-tools;$FALLBACK_BUILD_TOOLS_VERSION"; then
              echo "âœ… åå¤‡ç‰ˆæœ¬å®‰è£…æˆåŠŸ"
              SDK_SUCCESS=true
            fi
          fi
          
          if [ "$SDK_SUCCESS" = false ]; then
            echo "âŒ æ‰€æœ‰SDKç‰ˆæœ¬å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # ä¿®å¤å¯èƒ½çš„è·¯å¾„é—®é¢˜
          for version in $TARGET_SDK_VERSION $FALLBACK_SDK_VERSION; do
            if [ -d "$ANDROID_HOME/platforms/android-$version-2" ]; then
              echo "ğŸ”§ ä¿®å¤ android-$version-2 è·¯å¾„..."
              rm -rf "$ANDROID_HOME/platforms/android-$version"
              mv "$ANDROID_HOME/platforms/android-$version-2" "$ANDROID_HOME/platforms/android-$version"
            fi
          done
          
          # éªŒè¯å®‰è£…ç»“æœ
          if [ -f "$ANDROID_HOME/platforms/android-$TARGET_SDK_VERSION/android.jar" ]; then
            echo "ACTUAL_PLATFORM_VERSION=android-$TARGET_SDK_VERSION" >> $GITHUB_ENV
            echo "COMPILE_SDK_VERSION=$TARGET_SDK_VERSION" >> $GITHUB_ENV
            echo "âœ… ä½¿ç”¨ç›®æ ‡ç‰ˆæœ¬ android-$TARGET_SDK_VERSION"
          elif [ -f "$ANDROID_HOME/platforms/android-$FALLBACK_SDK_VERSION/android.jar" ]; then
            echo "ACTUAL_PLATFORM_VERSION=android-$FALLBACK_SDK_VERSION" >> $GITHUB_ENV
            echo "COMPILE_SDK_VERSION=$FALLBACK_SDK_VERSION" >> $GITHUB_ENV
            echo "âœ… ä½¿ç”¨åå¤‡ç‰ˆæœ¬ android-$FALLBACK_SDK_VERSION"
          else
            echo "âŒ æ‰€æœ‰SDKç‰ˆæœ¬éªŒè¯å¤±è´¥"
            exit 1
          fi
          
          # è®¾ç½®build-toolsç‰ˆæœ¬
          if [ -d "$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION" ]; then
            echo "ACTUAL_BUILD_TOOLS_VERSION=$BUILD_TOOLS_VERSION" >> $GITHUB_ENV
          else
            echo "ACTUAL_BUILD_TOOLS_VERSION=$FALLBACK_BUILD_TOOLS_VERSION" >> $GITHUB_ENV
          fi
          
          echo "âœ… SDKé…ç½®å®Œæˆ"

      - name: é…ç½®æ„å»ºç¯å¢ƒ
        timeout-minutes: 5
        run: |
          set -e
          echo "ğŸ”’ é…ç½® Gradle å’Œ Flutter ç¯å¢ƒ..."
          
          # éªŒè¯ç¯å¢ƒå˜é‡
          if [ -z "$ANDROID_HOME" ]; then
            echo "âŒ ANDROID_HOME æœªè®¾ç½®"
            exit 1
          fi
          
          # ç¦æ­¢ Gradle è‡ªåŠ¨ä¸‹è½½ SDK
          mkdir -p android
          echo "android.builder.sdkDownload=false" >> android/gradle.properties
          echo "org.gradle.daemon=false" >> android/gradle.properties
          echo "org.gradle.configureondemand=true" >> android/gradle.properties
          
          # ç”Ÿæˆ local.properties
          cat > android/local.properties << 'EOF'
          sdk.dir=$ANDROID_HOME
          flutter.sdk=\$FLUTTER_ROOT
          flutter.buildMode=debug
          flutter.versionName=1.0.0
          flutter.versionCode=1
          EOF
          
          # è®¾ç½® Flutter ç¯å¢ƒå˜é‡
          echo "FLUTTER_ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "GRADLE_USER_HOME=$PWD/.gradle" >> $GITHUB_ENV
          echo "FLUTTER_ROOT=/opt/hostedtoolcache/flutter/stable-3.27.5-x64" >> $GITHUB_ENV
          
          echo "âœ… æ„å»ºç¯å¢ƒé…ç½®å®Œæˆ"

      - name: ç¼“å­˜ Gradle ä¾èµ–
        uses: actions/cache@v4
        timeout-minutes: 5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2.16.0
        timeout-minutes: 10
        with:
          flutter-version: '3.27.5'
          channel: 'stable'
          cache: true
          cache-key: "flutter-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml', '**/pubspec.lock') }}"

      - name: æ„å»º APK (Debug)
        timeout-minutes: 20
        run: |
          set -e
          echo "ğŸš€ å¼€å§‹æ„å»º APK..."
          
          # éªŒè¯ç¯å¢ƒå˜é‡
          if [ -z "$COMPILE_SDK_VERSION" ]; then
            echo "âŒ COMPILE_SDK_VERSION æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "$ACTUAL_PLATFORM_VERSION" ]; then
            echo "âŒ ACTUAL_PLATFORM_VERSION æœªè®¾ç½®"
            exit 1
          fi
          
          echo "ä½¿ç”¨çš„å¹³å°ç‰ˆæœ¬: $ACTUAL_PLATFORM_VERSION"
          echo "ç¼–è¯‘ SDK ç‰ˆæœ¬: $COMPILE_SDK_VERSION"
          
          # æ¸…ç†å¹¶å‡†å¤‡
          flutter clean
          flutter pub get
          flutter doctor -v
          
          # å¦‚æœéœ€è¦é™çº§ç‰ˆæœ¬ï¼Œä½¿ç”¨ sed é«˜æ•ˆæ›´æ–°é…ç½®
          if [ "$COMPILE_SDK_VERSION" = "$FALLBACK_SDK_VERSION" ]; then
            echo "ğŸ”„ æ›´æ–°æ„å»ºé…ç½®ä¸º android-$FALLBACK_SDK_VERSION..."
            sed -i.tmp \
              -e "s/^[[:space:]]*compileSdk[[:space:]]*=[[:space:]]*[0-9].*/    compileSdk = $FALLBACK_SDK_VERSION/" \
              -e "s/^[[:space:]]*targetSdk[[:space:]]*=[[:space:]]*[0-9].*/    targetSdk = $FALLBACK_SDK_VERSION/" \
              android/app/build.gradle.kts
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f android/app/build.gradle.kts.tmp
          fi
          
          # æ‰§è¡Œæ„å»º
          flutter build apk --debug || {
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œå¼€å§‹è¯Šæ–­..."
            flutter doctor -v
            echo "Gradle é…ç½®:"
            cat android/local.properties
            exit 1
          }

      - name: éªŒè¯æ„å»ºç»“æœ
        timeout-minutes: 5
        run: |
          set -e
          echo "ğŸ” æŸ¥æ‰¾å¹¶éªŒè¯ç”Ÿæˆçš„ APK æ–‡ä»¶..."
          
          # æŸ¥æ‰¾APKæ–‡ä»¶
          APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null || true)
          
          if [ -z "$APK_FILES" ]; then
            echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°ä»¥ä¸‹ APK æ–‡ä»¶:"
          for apk in $APK_FILES; do
            if [ -f "$apk" ]; then
              SIZE=$(stat -c%s "$apk")
              echo "- $(basename "$apk") ($SIZE bytes)"
            fi
          done
          
      - name: ä¸Šä¼  APK ä¸º Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.run_number }}
          path: build/**/*.apk
          retention-days: 30
          if-no-files-found: warn

      - name: åˆ›å»º Release
        if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}
        uses: softprops/action-gh-release@v2
        timeout-minutes: 5
        with:
          tag_name: build-${{ github.run_number }}
          name: Build ${{ github.run_number }}
          body: |
            ## è‡ªåŠ¨æ„å»ºçš„ Debug ç‰ˆæœ¬
            
            **æ„å»ºä¿¡æ¯ï¼š**
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
            - Run: #${{ github.run_number }}
            - å¹³å°ç‰ˆæœ¬: ${{ env.ACTUAL_PLATFORM_VERSION || 'unknown' }}
            - ç¼–è¯‘ç‰ˆæœ¬: ${{ env.COMPILE_SDK_VERSION || 'unknown' }}
            - æ„å»ºå·¥å…·ç‰ˆæœ¬: ${{ env.ACTUAL_BUILD_TOOLS_VERSION || 'unknown' }}
            
            **APK è¯´æ˜ï¼š**
            æ­¤æ„å»ºåŒ…å« Debug ç‰ˆæœ¬çš„ APK æ–‡ä»¶ã€‚
          files: build/**/*.apk
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}