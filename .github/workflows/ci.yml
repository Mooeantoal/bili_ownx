name: CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  standard-build:
    name: Standard Build
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: å®‰è£… Android SDK åŸºç¡€ç»„ä»¶
        run: |
          # ä¸‹è½½å¹¶å®‰è£… Android SDK å‘½ä»¤è¡Œå·¥å…·
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mkdir -p $PWD/android-sdk/cmdline-tools/latest
          mv cmdline-tools/* $PWD/android-sdk/cmdline-tools/latest/
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "ANDROID_HOME=$PWD/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$PWD/android-sdk" >> $GITHUB_ENV
          echo "$PWD/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH

      - name: é…ç½® Android SDK è®¸å¯è¯
        run: |
          # å®‰è£…å¿…è¦çš„å·¥å…·
          sudo apt-get update && sudo apt-get install -y expect || true
          
          # ä½¿ç”¨ä¸“ç”¨è„šæœ¬é…ç½®è®¸å¯è¯ç»•è¿‡
          chmod +x .github/scripts/bypass-licenses.sh
          bash .github/scripts/bypass-licenses.sh "$PWD/android-sdk"
          
          # é¢å¤–çš„ç¯å¢ƒå˜é‡è®¾ç½®
          echo "COMPILE_SDK_VERSION=35" >> $GITHUB_ENV
          echo "BUILD_TOOLS_VERSION=35.0.0" >> $GITHUB_ENV

      - name: å®‰è£… Android SDK ç»„ä»¶
        run: |
          # ä½¿ç”¨å¼ºåˆ¶å®‰è£…è„šæœ¬
          echo "ğŸš€ å¼€å§‹å®‰è£… Android SDK ç»„ä»¶..."
          
          # ä½¿ç”¨å¼ºåˆ¶å®‰è£…è„šæœ¬
          chmod +x .github/scripts/install-sdk-components-force.sh
          bash .github/scripts/install-sdk-components-force.sh "platforms;android-35 build-tools;35.0.0"
          
          echo "ğŸ“Š å®‰è£…å®Œæˆåçš„ç›®å½•ç»“æ„:"
          ls -la $ANDROID_HOME/platforms/ || echo "platforms ç›®å½•ä¸å­˜åœ¨"
          ls -la $ANDROID_HOME/build-tools/ || echo "build-tools ç›®å½•ä¸å­˜åœ¨"
          
          echo "ğŸ” æ£€æŸ¥å·²å®‰è£…ç»„ä»¶:"
          sdkmanager --list_installed || echo "æ— æ³•åˆ—å‡ºå·²å®‰è£…ç»„ä»¶"

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: æ„å»º APK (Debug)
        run: |
          echo "å¼€å§‹æ„å»º APK..."
          flutter clean
          flutter pub get
          flutter build apk --debug --verbose

      - name: ä¸Šä¼  APK ä¸º Artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: standard-build-${{ github.run_number }}
          path: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: åˆ›å»º Release
        if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Build ${{ github.run_number }}
          body: |
            ## è‡ªåŠ¨æ„å»ºçš„ Debug ç‰ˆæœ¬
            
            **æ„å»ºä¿¡æ¯ï¼š**
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
            - Run: #${{ github.run_number }}
            
            **APK è¯´æ˜ï¼š**
            æ­¤æ„å»ºå·²å¯ç”¨ ABI åˆ†å‰²ï¼ŒåŒ…å«ä»¥ä¸‹æ¶æ„çš„ APKï¼š
            - `app-arm64-v8a-debug.apk`: é€‚ç”¨äº 64 ä½ ARM è®¾å¤‡ï¼ˆç°ä»£æ‰‹æœºï¼Œæ¨èï¼‰
            - `app-armeabi-v7a-debug.apk`: é€‚ç”¨äº 32 ä½ ARM è®¾å¤‡
            - `app-universal-debug.apk`: é€šç”¨ç‰ˆæœ¬ï¼ˆå…¼å®¹æ‰€æœ‰æ¶æ„ï¼Œä½“ç§¯è¾ƒå¤§ï¼‰
            
            è¯·æ ¹æ®æ‚¨çš„è®¾å¤‡é€‰æ‹©å¯¹åº”æ¶æ„çš„ APK ä¸‹è½½å®‰è£…ã€‚
          files: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/debug/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}