name: CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  standard-build:
    name: Standard Build
    runs-on: ubuntu-latest
    env:
      ACTUAL_PLATFORM_VERSION: 'android-35'
      ACTUAL_BUILD_TOOLS_VERSION: '35.0.0'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: è®¾ç½® Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: å®‰è£… Android SDK åŸºç¡€ç»„ä»¶
        run: |
          # ä¸‹è½½å¹¶å®‰è£… Android SDK å‘½ä»¤è¡Œå·¥å…·
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mkdir -p $PWD/android-sdk/cmdline-tools/latest
          mv cmdline-tools/* $PWD/android-sdk/cmdline-tools/latest/
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          echo "ANDROID_HOME=$PWD/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$PWD/android-sdk" >> $GITHUB_ENV
          echo "$PWD/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH

      - name: é…ç½® Android SDK è®¸å¯è¯
        run: |
          # å®‰è£…å¿…è¦çš„å·¥å…·
          sudo apt-get update && sudo apt-get install -y expect || true
          
          # æ£€æŸ¥è®¸å¯è¯è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ -f ".github/scripts/bypass-licenses.sh" ]; then
            chmod +x .github/scripts/bypass-licenses.sh
            bash .github/scripts/bypass-licenses.sh "$PWD/android-sdk"
          else
            echo "âš ï¸ è­¦å‘Š: bypass-licenses.sh è„šæœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤è®¸å¯è¯é…ç½®"
            mkdir -p "$ANDROID_HOME/licenses"
            echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_HOME/licenses/android-sdk-license"
            echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
            echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > "$ANDROID_HOME/licenses/android-sdk-sdk-preview-license"
          fi
          
          # é¢å¤–çš„çŽ¯å¢ƒå˜é‡è®¾ç½®
          echo "COMPILE_SDK_VERSION=35" >> $GITHUB_ENV
          echo "BUILD_TOOLS_VERSION=35.0.0" >> $GITHUB_ENV

      - name: å®‰è£… Android SDK ç»„ä»¶
        run: |
          # é¢„é˜²æ€§æ¸…ç†ï¼šå¦‚æžœ android-35 å­˜åœ¨ä½†ä¸ºç©ºæˆ–æ— æ•ˆï¼Œå…ˆåˆ é™¤ï¼Œé¿å…å®‰è£…åˆ° android-35-2
          if [ -d "$ANDROID_HOME/platforms/android-35" ]; then
            if [ ! -f "$ANDROID_HOME/platforms/android-35/android.jar" ]; then
              echo "ðŸ§¹ [Pre-install] åˆ é™¤æ— æ•ˆçš„ android-35 ç›®å½•ä»¥é˜²æ­¢è·¯å¾„é”™ä½..."
              rm -rf "$ANDROID_HOME/platforms/android-35"
            fi
          fi

          # ä½¿ç”¨å¼ºåˆ¶å®‰è£…è„šæœ¬
          echo "ðŸš€ å¼€å§‹å®‰è£… Android SDK ç»„ä»¶..."
          
          # æ£€æŸ¥å®‰è£…è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ -f ".github/scripts/install-sdk-components-force.sh" ]; then
            chmod +x .github/scripts/install-sdk-components-force.sh
            bash .github/scripts/install-sdk-components-force.sh "platforms;android-35 build-tools;35.0.0"
          else
            echo "âš ï¸ è­¦å‘Š: install-sdk-components-force.sh è„šæœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨ sdkmanager ç›´æŽ¥å®‰è£…"
            sdkmanager "platforms;android-35" "build-tools;35.0.0" || {
              echo "âŒ SDKç»„ä»¶å®‰è£…å¤±è´¥ï¼Œå°è¯•é™çº§ç‰ˆæœ¬..."
              sdkmanager "platforms;android-34" "build-tools;34.0.0"
            }
          fi
          
          echo "ðŸ“Š å®‰è£…å®ŒæˆåŽçš„ç›®å½•ç»“æž„:"
          ls -la $ANDROID_HOME/platforms/ $ANDROID_HOME/build-tools/ || {
            echo "âŒ å¹³å°æˆ–æž„å»ºå·¥å…·ç›®å½•ä¸å­˜åœ¨"
            exit 1
          }
          
          echo "ðŸ” æ£€æŸ¥å·²å®‰è£…ç»„ä»¶:"
          sdkmanager --list_installed || echo "æ— æ³•åˆ—å‡ºå·²å®‰è£…ç»„ä»¶"

      - name: ä¿®å¤ Android SDK 35 è·¯å¾„
        run: |
          echo "ðŸ”§ ä¿®å¤ Android SDK 35 è·¯å¾„é—®é¢˜..."
          
          # STRATEGY: Aggressive Fix
          # åªè¦å‘çŽ° android-35-2ï¼Œå°±è¯´æ˜Žå®‰è£…é”™ä½äº†ã€‚ç›´æŽ¥ç”¨å®ƒå¼ºåˆ¶æ›¿æ¢ android-35ã€‚
          
          if [ -d "$ANDROID_HOME/platforms/android-35-2" ]; then
            echo "ðŸš¨ æ£€æµ‹åˆ° android-35-2ï¼Œè§¦å‘æ¿€è¿›ä¿®å¤ç­–ç•¥ï¼"
            echo "   åŽŸå› ï¼šSDKå¯èƒ½å› ä¸º android-35 ç›®å½•é¢„å­˜åœ¨è€Œå®‰è£…åˆ°äº† android-35-2"
            
            # æ— è®º android-35 æ˜¯å¦å­˜åœ¨ï¼Œç›´æŽ¥åˆ é™¤ï¼Œä¸ºé‡å‘½åè®©è·¯
            if [ -d "$ANDROID_HOME/platforms/android-35" ]; then
                echo "ðŸ—‘ï¸ å¼ºåˆ¶åˆ é™¤çŽ°æœ‰çš„ android-35 ç›®å½•..."
                rm -rf "$ANDROID_HOME/platforms/android-35"
            fi
            
            echo "ðŸ”„ å°† android-35-2 é‡å‘½åä¸º android-35..."
            mv "$ANDROID_HOME/platforms/android-35-2" "$ANDROID_HOME/platforms/android-35"
            echo "âœ… è·¯å¾„ä¿®å¤å®Œæˆ"
          fi
          
          # äºŒæ¬¡æ£€æŸ¥ï¼šç»è¿‡æ¿€è¿›ä¿®å¤åŽï¼Œæˆ–è€…å¦‚æžœæ²¡æœ‰ trigger æ¿€è¿›ä¿®å¤ï¼Œæ£€æŸ¥ android-35 çŠ¶æ€
          if [ -d "$ANDROID_HOME/platforms/android-35" ]; then
             if [ ! -f "$ANDROID_HOME/platforms/android-35/android.jar" ]; then
                echo "âŒ android-35 å­˜åœ¨ä½†å…³é”®æ–‡ä»¶(android.jar)ç¼ºå¤±ï¼Œè§†ä¸ºæ— æ•ˆï¼Œåˆ é™¤..."
                rm -rf "$ANDROID_HOME/platforms/android-35"
             else
                echo "âœ… android-35 æ£€æŸ¥é€šè¿‡"
             fi
          fi
          
          # å¦‚æžœæ­¤æ—¶ android-35 ä»ç„¶ä¸å­˜åœ¨ï¼Œè¯´æ˜Žä¹‹å‰çš„å®‰è£…å®Œå…¨å¤±è´¥ï¼Œå°è¯•è¡¥æ•‘
          if [ ! -d "$ANDROID_HOME/platforms/android-35" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ android-35ï¼Œå°è¯•ä½¿ç”¨ sdkmanager é‡æ–°å®‰è£…..."
            sdkmanager "platforms;android-35" || {
               echo "âŒ sdkmanager è¡¥æ•‘å®‰è£…å¤±è´¥"
            }
            
            # è¡¥æ•‘å®‰è£…åŽå†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰ -2
            if [ -d "$ANDROID_HOME/platforms/android-35-2" ]; then
                echo "ðŸš¨ è¡¥æ•‘å®‰è£…åˆäº§ç”Ÿäº† android-35-2ï¼Œå†æ¬¡ä¿®å¤..."
                rm -rf "$ANDROID_HOME/platforms/android-35"
                mv "$ANDROID_HOME/platforms/android-35-2" "$ANDROID_HOME/platforms/android-35"
            fi
          fi
          
          # æœ€ç»ˆéªŒè¯ä¸Žé™çº§å†³ç­–
          if [ -d "$ANDROID_HOME/platforms/android-35" ] && [ -f "$ANDROID_HOME/platforms/android-35/android.jar" ]; then
            echo "ðŸŽ‰ æœ€ç»ˆç¡®è®¤: android-35 å¯ç”¨"
            echo "ACTUAL_PLATFORM_VERSION=android-35" >> $GITHUB_ENV
            echo "COMPILE_SDK_VERSION=35" >> $GITHUB_ENV
          else
            echo "âŒ android-35 æœ€ç»ˆä¸å¯ç”¨ï¼Œå°è¯•é™çº§åˆ° android-34..."
            if [ -d "$ANDROID_HOME/platforms/android-34" ]; then
               echo "âœ… é™çº§ä½¿ç”¨çŽ°æœ‰çš„ android-34"
               echo "ACTUAL_PLATFORM_VERSION=android-34" >> $GITHUB_ENV
               echo "COMPILE_SDK_VERSION=34" >> $GITHUB_ENV
            else
               echo "âš ï¸ android-34 ä¸å­˜åœ¨ï¼Œå°è¯•å®‰è£…..."
               sdkmanager "platforms;android-34"
               if [ -d "$ANDROID_HOME/platforms/android-34" ]; then
                  echo "âœ… æˆåŠŸå®‰è£…å¹¶ä½¿ç”¨ android-34"
                  echo "ACTUAL_PLATFORM_VERSION=android-34" >> $GITHUB_ENV
                  echo "COMPILE_SDK_VERSION=34" >> $GITHUB_ENV
               else
                  echo "âŒ æ— æ³•èŽ·å–ä»»ä½•å¯ç”¨çš„ Android SDK å¹³å° (35 or 34)"
                  exit 1
               fi
            fi
          fi
          
          echo "ðŸ“Š æœ€ç»ˆå¹³å°é…ç½®ï¼š"
          echo "ä½¿ç”¨çš„å¹³å°ç‰ˆæœ¬: ${ACTUAL_PLATFORM_VERSION:-unknown}"
          echo "ç¼–è¯‘ SDK ç‰ˆæœ¬: ${COMPILE_SDK_VERSION:-unknown}"

      - name: éªŒè¯ Android SDK å®‰è£…
        run: |
          echo "ðŸ” éªŒè¯ Android SDK å®‰è£…..."
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          
          # æ£€æŸ¥å¹³å°å’Œæž„å»ºå·¥å…·æ˜¯å¦å­˜åœ¨ï¼ˆåˆå¹¶é‡å¤æ£€æŸ¥ï¼‰
          ls -la $ANDROID_HOME/platforms/ $ANDROID_HOME/build-tools/ || {
            echo "âŒ å¹³å°æˆ–æž„å»ºå·¥å…·ç›®å½•ä¸å­˜åœ¨"
            exit 1
          }
          
          # æ£€æŸ¥ android-35 å¹³å°ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™å°è¯•ä½¿ç”¨ android-34
          if [ -d "$ANDROID_HOME/platforms/android-35" ]; then
            echo "âœ… android-35 å¹³å°å­˜åœ¨"
            export SDK_PLATFORM="android-35"
          elif [ -d "$ANDROID_HOME/platforms/android-34" ]; then
            echo "âš ï¸ ä½¿ç”¨ android-34 å¹³å°ä½œä¸ºåŽå¤‡"
            export SDK_PLATFORM="android-34"
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„ Android SDK å¹³å°"
            exit 1
          fi
          
          # æ£€æŸ¥ build-tools 35.0.0ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™å°è¯•ä½¿ç”¨ 34.0.0
          if [ -d "$ANDROID_HOME/build-tools/35.0.0" ]; then
            echo "âœ… build-tools 35.0.0 å­˜åœ¨"
            export BUILD_TOOLS="35.0.0"
          elif [ -d "$ANDROID_HOME/build-tools/34.0.0" ]; then
            echo "âš ï¸ ä½¿ç”¨ build-tools 34.0.0 ä½œä¸ºåŽå¤‡"
            export BUILD_TOOLS="34.0.0"
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„æž„å»ºå·¥å…·"
            exit 1
          fi
          
          # ç”Ÿæˆæ­£ç¡®çš„ local.properties æ–‡ä»¶
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          echo "flutter.sdk=\$FLUTTER_ROOT" >> android/local.properties
          echo "flutter.buildMode=debug" >> android/local.properties
          echo "flutter.versionName=1.0.0" >> android/local.properties
          echo "flutter.versionCode=1" >> android/local.properties

          echo "ðŸ“„ ç”Ÿæˆçš„ local.properties å†…å®¹:"
          cat android/local.properties

          # è®¾ç½® Flutter ä½¿ç”¨çš„ Android SDK çŽ¯å¢ƒå˜é‡
          echo "FLUTTER_ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ACTUAL_PLATFORM_VERSION=$SDK_PLATFORM" >> $GITHUB_ENV
          echo "ACTUAL_BUILD_TOOLS_VERSION=$BUILD_TOOLS" >> $GITHUB_ENV
          
          # éªŒè¯ sdkmanager èƒ½æ‰¾åˆ°ç»„ä»¶
          sdkmanager --list_installed | grep -E "(platforms|build-tools)" || echo "æ— æ³•åˆ—å‡ºå·²å®‰è£…ç»„ä»¶"

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2.10.0
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true

      - name: æž„å»º APK (Debug)
        run: |
          echo "å¼€å§‹æž„å»º APK..."
          echo "å½“å‰ ANDROID_HOME: $ANDROID_HOME"
          echo "å½“å‰ FLUTTER_ANDROID_SDK_ROOT: $FLUTTER_ANDROID_SDK_ROOT"
          echo "å®žé™…ä½¿ç”¨å¹³å°ç‰ˆæœ¬: $ACTUAL_PLATFORM_VERSION"
          echo "å®žé™…ä½¿ç”¨æž„å»ºå·¥å…·ç‰ˆæœ¬: $ACTUAL_BUILD_TOOLS_VERSION"
          echo "ç¼–è¯‘ SDK ç‰ˆæœ¬: $COMPILE_SDK_VERSION"
          
          # éªŒè¯ Flutter èƒ½æ‰¾åˆ° Android SDK
          flutter doctor -v
          
          # è®¾ç½® Gradle ç”¨æˆ·ä¸»ç›®å½•ä»¥é¿å…æƒé™é—®é¢˜
          export GRADLE_USER_HOME=$PWD/.gradle
          
          flutter clean
          flutter pub get
          
          # å¦‚æžœé™çº§åˆ° android-34ï¼Œæ›´æ–° Gradle é…ç½®
          if [ "$COMPILE_SDK_VERSION" = "34" ]; then
            echo "ðŸ”„ æ£€æµ‹åˆ°ä½¿ç”¨ android-34ï¼Œæ›´æ–°æž„å»ºé…ç½®..."
            # åˆ›å»ºä¸´æ—¶çš„æž„å»ºé…ç½®æ–‡ä»¶
            cat > android/app/build.gradle.tmp << 'EOF'
            plugins {
                id("com.android.application")
                id("kotlin-android")
                id("dev.flutter.flutter-gradle-plugin")
            }

            android {
                namespace = "com.example.bili_ownx"
                compileSdk = 34  // é™çº§åˆ° 34
                ndkVersion = "27.0.12077973"
                
                compileOptions {
                    sourceCompatibility = JavaVersion.VERSION_1_8
                    targetCompatibility = JavaVersion.VERSION_1_8
                    isCoreLibraryDesugaringEnabled = true
                }
                
                kotlinOptions {
                    jvmTarget = "1.8"
                }
                
                dependenciesInfo {
                    includeInApk = false
                    includeInBundle = false
                }

                defaultConfig {
                    applicationId = "com.example.bili_ownx"
                    minSdk = flutter.minSdkVersion
                    targetSdk = 34  // é™çº§åˆ° 34
                    versionCode = flutter.versionCode
                    versionName = flutter.versionName
                }

                buildTypes {
                    release {
                        isMinifyEnabled = true
                        isShrinkResources = true
                        proguardFiles(
                            getDefaultProguardFile("proguard-android-optimize.txt"),
                            "proguard-rules.pro"
                        )
                        signingConfig = signingConfigs.getByName("debug")
                    }
                    
                    debug {
                        isMinifyEnabled = false
                        isShrinkResources = false
                    }
                }
                
                packaging {
                    resources {
                        excludes += listOf(
                            "META-INF/*.kotlin_module",
                            "META-INF/LICENSE.md",
                            "META-INF/LICENSE-notice.md",
                            "META-INF/AL2.0",
                            "META-INF/LGPL2.1",
                            "META-INF/NOTICE.md",
                            "META-INF/DEPENDENCIES",
                            "META-INF/gradle/incremental.annotation.processors",
                            "META-INF/*.properties",
                            "META-INF/proguard/*",
                            "META-INF/com.android.tools/annotations"
                        )
                    }
                }
            }

            flutter {
                source = "../.."
            }

            dependencies {
                coreLibraryDesugaring("com.android.tools:desugar_jdk_libs:2.0.4")
            }

            configurations.all {
                resolutionStrategy {
                    force("androidx.core:core-ktx:1.13.1")
                    force("androidx.appcompat:appcompat:1.7.0")
                    force("androidx.lifecycle:lifecycle-runtime:2.8.7")
                    force("androidx.lifecycle:lifecycle-common:2.8.7")
                    force("org.jetbrains.kotlin:kotlin-stdlib:2.0.21")
                    force("org.jetbrains.kotlin:kotlin-stdlib-common:2.0.21")
                    force("androidx.media3:media3-exoplayer:1.5.0")
                    force("androidx.media3:media3-common:1.5.0")
                    force("androidx.media3:media3-ui:1.5.0")
                    exclude(mapOf("group" to "com.google.guava", "module" to "listenablefuture"))
                }
            }
          EOF
            # å¤‡ä»½åŽŸæ–‡ä»¶å¹¶ä½¿ç”¨ä¸´æ—¶é…ç½®
            cp android/app/build.gradle.kts android/app/build.gradle.kts.backup
            mv android/app/build.gradle.tmp android/app/build.gradle.kts
          fi
          
          # å°è¯•æž„å»ºï¼Œå¦‚æžœå¤±è´¥åˆ™ä½¿ç”¨è¯¦ç»†ä¿¡æ¯è°ƒè¯•
          flutter build apk --debug --verbose || {
            echo "âŒ æž„å»ºå¤±è´¥ï¼Œå°è¯•è°ƒè¯•..."
            echo "Android SDK å†…å®¹:"
            find $ANDROID_HOME -name "*android*" -type d | head -10
            echo "Gradle é…ç½®:"
            cat android/local.properties
            echo "çŽ¯å¢ƒå˜é‡:"
            env | grep -E "(ANDROID|FLUTTER|GRADLE)"
            
            # å¦‚æžœä½¿ç”¨äº†ä¸´æ—¶é…ç½®ï¼Œæ¢å¤åŽŸæ–‡ä»¶
            if [ "$COMPILE_SDK_VERSION" = "34" ] && [ -f android/app/build.gradle.kts.backup ]; then
              echo "æ¢å¤åŽŸå§‹æž„å»ºé…ç½®..."
              mv android/app/build.gradle.kts.backup android/app/build.gradle.kts
            fi
            
            exit 1
          }
          
          # å¦‚æžœä½¿ç”¨äº†ä¸´æ—¶é…ç½®ï¼Œæ¢å¤åŽŸæ–‡ä»¶
          if [ "$COMPILE_SDK_VERSION" = "34" ] && [ -f android/app/build.gradle.kts.backup ]; then
            echo "æ¢å¤åŽŸå§‹æž„å»ºé…ç½®..."
            mv android/app/build.gradle.kts.backup android/app/build.gradle.kts
          fi

      - name: ä¸Šä¼  APK ä¸º Artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: standard-build-${{ github.run_number }}
          path: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: åˆ›å»º Release
        if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Build ${{ github.run_number }}
          body: |
            ## è‡ªåŠ¨æž„å»ºçš„ Debug ç‰ˆæœ¬
            
            **æž„å»ºä¿¡æ¯ï¼š**
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
            - Run: #${{ github.run_number }}
            - å¹³å°ç‰ˆæœ¬: ${{ env.ACTUAL_PLATFORM_VERSION || 'android-35' }}
            - æž„å»ºå·¥å…·ç‰ˆæœ¬: ${{ env.ACTUAL_BUILD_TOOLS_VERSION || '35.0.0' }}
            
            **APK è¯´æ˜Žï¼š**
            æ­¤æž„å»ºå·²å¯ç”¨ ABI åˆ†å‰²ï¼ŒåŒ…å«ä»¥ä¸‹æž¶æž„çš„ APKï¼š
            - `app-arm64-v8a-debug.apk`: é€‚ç”¨äºŽ 64 ä½ ARM è®¾å¤‡ï¼ˆçŽ°ä»£æ‰‹æœºï¼ŒæŽ¨èï¼‰
            - `app-armeabi-v7a-debug.apk`: é€‚ç”¨äºŽ 32 ä½ ARM è®¾å¤‡
            - `app-universal-debug.apk`: é€šç”¨ç‰ˆæœ¬ï¼ˆå…¼å®¹æ‰€æœ‰æž¶æž„ï¼Œä½“ç§¯è¾ƒå¤§ï¼‰
            
            è¯·æ ¹æ®æ‚¨çš„è®¾å¤‡é€‰æ‹©å¯¹åº”æž¶æž„çš„ APK ä¸‹è½½å®‰è£…ã€‚
          files: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/debug/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}