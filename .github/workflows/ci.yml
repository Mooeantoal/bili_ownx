name: CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  standard-build:
    name: Standard Build
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 设置 Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: 安装 Android SDK 基础组件
        run: |
          # 下载并安装 Android SDK 命令行工具
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mkdir -p $PWD/android-sdk/cmdline-tools/latest
          mv cmdline-tools/* $PWD/android-sdk/cmdline-tools/latest/
          
          # 设置环境变量
          echo "ANDROID_HOME=$PWD/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$PWD/android-sdk" >> $GITHUB_ENV
          echo "$PWD/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH

      - name: 配置 Android SDK 许可证
        run: |
          # 强制创建所有许可证文件
          mkdir -p $PWD/android-sdk/licenses
          mkdir -p ~/.android
          
          # 创建所有必要的许可证文件
          echo "24333f8a63b6825ea9c55141383a0746b3326" > $PWD/android-sdk/licenses/android-sdk-license
          echo "84831b9409646a918e30573bab4c9d966a64d" > $PWD/android-sdk/licenses/android-sdk-preview
          echo "8933bad161af4178b1185d1a37fbf41ea5269c" > $PWD/android-sdk/licenses/android-sdk-build-tools-license
          echo "8933bad161af4178b1185d1a37fbf41ea5269c" > $PWD/android-sdk/licenses/android-sdk-platform-tools-license
          echo "8f4ff02255e750b71392994d1d649be0b947ad1" > $PWD/android-sdk/licenses/google-android-play-auth-license
          echo "859f317ff2ccae9e4e47567d3db0f379c8c2f3e" > $PWD/android-sdk/licenses/google-android-play-location-license
          echo "d975f751698a77b6691ed5e903457d56aeac7c" > $PWD/android-sdk/licenses/android-sdk-androidxr-license
          echo "601085b94cd77d045dc5891f2b9bffa8a385" > $PWD/android-sdk/licenses/android-googletv-license
          
          # 设置权限
          chmod 644 $PWD/android-sdk/licenses/* 2>/dev/null || true
          
          # 创建全局配置
          echo "### User Settings for Android SDK" > ~/.android/repositories.cfg
          echo "count=0" >> ~/.android/repositories.cfg
          
          # 设置环境变量
          echo "ANDROID_SDKMANAGER_ALLOW_PRE25=true" >> $GITHUB_ENV
          echo "ANDROID_SDK_LICENSES_ACCEPTED=true" >> $GITHUB_ENV
          echo "SDKMANAGER_ALLOW_ACCEPT_LICENSES=true" >> $GITHUB_ENV
          echo "GRADLE_OPTS=-Dandroid.acceptLicense=true" >> $GITHUB_ENV
          
          echo "✅ 许可证配置完成"

      - name: 安装 Android SDK 组件
        run: |
          echo "开始安装 Android SDK 组件..."
          
          # 创建必要的目录结构
          mkdir -p $ANDROID_HOME/platforms
          mkdir -p $ANDROID_HOME/build-tools
          
          # 使用 expect 或 yes 自动确认
          if command -v yes >/dev/null 2>&1; then
            # 使用 yes 命令
            yes | sdkmanager --install "platforms;android-35" "build-tools;35.0.0" 2>/dev/null || true
          else
            # 使用 printf 生成多个 y
            printf "y\ny\ny\ny\ny\ny\ny\ny\ny\ny\ny\n" | sdkmanager --install "platforms;android-35" "build-tools;35.0.0" 2>/dev/null || true
          fi
          
          echo "安装完成，检查目录结构..."
          ls -la $ANDROID_HOME/platforms/ || echo "platforms 目录不存在"
          ls -la $ANDROID_HOME/build-tools/ || echo "build-tools 目录不存在"

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: 构建 APK (Debug)
        run: |
          echo "开始构建 APK..."
          flutter clean
          flutter pub get
          flutter build apk --debug --verbose

      - name: 上传 APK 为 Artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: standard-build-${{ github.run_number }}
          path: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: 创建 Release
        if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Build ${{ github.run_number }}
          body: |
            ## 自动构建的 Debug 版本
            
            **构建信息：**
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
            - Run: #${{ github.run_number }}
            
            **APK 说明：**
            此构建已启用 ABI 分割，包含以下架构的 APK：
            - `app-arm64-v8a-debug.apk`: 适用于 64 位 ARM 设备（现代手机，推荐）
            - `app-armeabi-v7a-debug.apk`: 适用于 32 位 ARM 设备
            - `app-universal-debug.apk`: 通用版本（兼容所有架构，体积较大）
            
            请根据您的设备选择对应架构的 APK 下载安装。
          files: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/debug/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}