name: Build Without License Issues

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  build-without-license:
    name: Build APK (No License Issues)
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v5
        
      - name: 设置 Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          
      - name: 设置 Android SDK (最小化)
        uses: android-actions/setup-android@v2
        
      - name: 创建许可证文件绕过交互
        run: |
          echo "=== 直接创建许可证文件 ==="
          
          # 确保目录存在
          mkdir -p $ANDROID_HOME/licenses
          
          # 创建所有必需的许可证文件
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55d" > $ANDROID_HOME/licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > $ANDROID_HOME/licenses/android-sdk-preview-license
          echo "84831b9409646a918e30573bab4c9c91346b8b90" > $ANDROID_HOME/licenses/google-gdk
          echo "598de3781d13c8c5df5a678110464d3863734768" > $ANDROID_HOME/licenses/android-sdk-google-license
          echo "24333f8a63b6825ea9c5514e83c0e9a993a0a6f" > $ANDROID_HOME/licenses/android-sdk-arm-dbt-license
          echo "33b6a2b64607111b2893360c6b44c7a64512267" > $ANDROID_HOME/licenses/intel-android-extra-license
          echo "84831b9409646a918e30573bab4c9c91346b8b90" > $ANDROID_HOME/licenses/mips-android-extra-license
          
          # 设置权限
          chmod 644 $ANDROID_HOME/licenses/*
          
          echo "许可证文件创建完成："
          ls -la $ANDROID_HOME/licenses/
          
      - name: 设置环境变量
        run: |
          echo "=== 设置环境变量 ==="
          export ANDROID_SDK_ACCEPT_LICENSES=true
          export ACCEPT_LICENSES=true
          echo "环境变量设置完成"
          
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.0'
          channel: 'stable'
          cache: true
          
      - name: 环境验证
        run: |
          echo "=== 环境信息 ==="
          echo "JAVA_HOME: $JAVA_HOME"
          echo "ANDROID_HOME: $ANDROID_HOME"
          java -version
          flutter --version
          echo "许可证文件："
          ls -la $ANDROID_HOME/licenses/ || echo "无许可证目录"
          
      - name: 快速构建
        run: |
          echo "=== 开始构建 ==="
          flutter clean
          flutter pub get
          
          # 确保语法正确
          if grep -q "minSdk = 21" android/app/build.gradle.kts; then
            echo "修复语法错误: minSdk = 21 -> minSdkVersion(21)"
            sed -i 's/minSdk = 21/minSdkVersion(21)/' android/app/build.gradle.kts
          fi
          
          # 构建时禁用许可证检查
          export GRADLE_OPTS="-Dandroid.accept licenses=true"
          flutter build apk --debug --no-tree-shake-icons
          
      - name: 上传APK
        uses: actions/upload-artifact@v4
        with:
          name: build-apk-no-license-${{ github.run_number }}
          path: |
            build/app/outputs/flutter-apk/*.apk
            android/app/build/outputs/apk/debug/*.apk
          retention-days: 30