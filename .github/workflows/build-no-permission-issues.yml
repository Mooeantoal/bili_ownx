name: Build Without Permission Issues

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-no-permission:
    name: Build APK (No Permission Issues)
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v5
        
      - name: 设置 Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          
      - name: 设置 Android SDK (最小化)
        uses: android-actions/setup-android@v2
        
      - name: 完全绕过许可证（基于环境变量）
        run: |
          echo "=== 完全基于环境变量的许可证方案 ==="
          
          # 设置所有可能的环境变量
          export ANDROID_SDK_ACCEPT_LICENSES=true
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          export ACCEPT_LICENSES=true
          export GRADLE_OPTS="-Dandroid.accept licenses=true -Dandroid.licenses.accepted=true"
          
          # 创建用户级别的许可证目录（有写权限）
          USER_LICENSE_DIR="$HOME/.android/licenses"
          mkdir -p "$USER_LICENSE_DIR"
          
          # 在用户目录创建许可证文件
          cat > "$USER_LICENSE_DIR/android-sdk-license" << 'EOF'
8933bad161af4178b1185d1a37fbf41ea5269c55d
EOF
          
          cat > "$USER_LICENSE_DIR/android-googletv-license" << 'EOF'
601085b53c84555a2897545eb1f38b296baeb1b5
EOF
          
          cat > "$USER_LICENSE_DIR/android-sdk-preview-license" << 'EOF'
d56f5187479451eabf01fb78af6dfcb131a6481e
EOF
          
          cat > "$USER_LICENSE_DIR/google-gdk" << 'EOF'
84831b9409646a918e30573bab4c9c91346b8b90
EOF
          
          chmod 644 "$USER_LICENSE_DIR"/*
          
          echo "用户许可证目录创建完成："
          ls -la "$USER_LICENSE_DIR/"
          
      - name: 使用 expect 处理许可证（长时间）
        run: |
          echo "=== 使用 expect 长时间处理许可证 ==="
          
          # 设置环境变量
          export ANDROID_SDK_ACCEPT_LICENSES=true
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          export ACCEPT_LICENSES=true
          
          # 安装 expect（如果不可用）
          if ! command -v expect &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y expect || echo "无法安装 expect"
          fi
          
          # 使用 expect 处理许可证（增加超时时间）
          if command -v expect &> /dev/null; then
            echo "使用 expect 处理许可证（5分钟超时）..."
            timeout 300 expect -c "
            set timeout 300
            spawn $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
            expect {
              \"y/N?\" { send \"y\r\"; exp_continue }
              \"(y/N)\" { send \"y\r\"; exp_continue }
              \"Accept? (y/N)\" { send \"y\r\"; exp_continue }
              \"Review licenses that have not been accepted\" { send \"y\r\"; exp_continue }
              \"License android-googletv-license\" { send \"y\r\"; exp_continue }
              \"License android-sdk-license\" { send \"y\r\"; exp_continue }
              \"License android-sdk-preview-license\" { send \"y\r\"; exp_continue }
              \"License google-gdk\" { send \"y\r\"; exp_continue }
              timeout { continue }
              eof { exit 0 }
            }
            " || echo "expect 处理完成（可能有警告）"
          else
            echo "expect 不可用，使用 yes 命令"
            # 使用 yes 命令长时间运行
            timeout 300 yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || echo "yes 处理完成"
          fi
          
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.0'
          channel: 'stable'
          cache: true
          
      - name: 环境验证
        run: |
          echo "=== 环境验证 ==="
          echo "JAVA_HOME: $JAVA_HOME"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_SDK_ACCEPT_LICENSES: $ANDROID_SDK_ACCEPT_LICENSES"
          echo "GRADLE_OPTS: $GRADLE_OPTS"
          echo "用户许可证目录："
          ls -la "$HOME/.android/licenses/" || echo "无用户许可证目录"
          
      - name: 构建（带环境变量保护）
        run: |
          echo "=== 构建项目 ==="
          flutter clean
          flutter pub get
          
          # 确保语法正确
          if grep -q "minSdk = 21" android/app/build.gradle.kts; then
            echo "修复语法错误: minSdk = 21 -> minSdkVersion(21)"
            sed -i 's/minSdk = 21/minSdkVersion(21)/' android/app/build.gradle.kts
          fi
          
          # 设置所有环境变量
          export ANDROID_SDK_ACCEPT_LICENSES=true
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          export ACCEPT_LICENSES=true
          export GRADLE_OPTS="-Dandroid.accept licenses=true -Dandroid.licenses.accepted=true"
          
          # 构建
          flutter build apk --debug --no-tree-shake-icons --verbose
          
      - name: 上传APK
        uses: actions/upload-artifact@v4
        with:
          name: build-no-permission-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 30