name: Minimal Build (No TV)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 设置 Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: 设置 Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'
        
    - name: 降级 SDK 版本以避免 TV 依赖
      run: |
        echo "=== 降级 SDK 版本 ==="
        sed -i 's/compileSdk = 35/compileSdk = 34/' android/app/build.gradle.kts
        sed -i 's/targetSdk = 35/targetSdk = 34/' android/app/build.gradle.kts
        
        echo "修改后的 build.gradle.kts:"
        grep -E "(compileSdk|targetSdk)" android/app/build.gradle.kts
        
    - name: 设置 Android SDK
      uses: android-actions/setup-android@v3
      
    - name: 最小许可证处理
      run: |
        echo "=== 最小许可证处理 ==="
        export ANDROID_SDK_ACCEPT_LICENSES=true
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export ACCEPT_LICENSES=true
        
        # 只创建最基本的许可证
        USER_LICENSE_DIR="$HOME/.android/licenses"
        mkdir -p "$USER_LICENSE_DIR"
        
        cat > "$USER_LICENSE_DIR/android-sdk-license" << 'EOF'
        8933bad161af4178b1185d1a37fbf41ea5269c55d
        EOF
        
        cat > "$USER_LICENSE_DIR/android-sdk-preview-license" << 'EOF'
        d56f5187479451eabf01fb78af6dfcb131a6481e
        EOF
        
        cat > "$USER_LICENSE_DIR/google-gdk" << 'EOF'
        84831b9409646a918e30573bab4c9c91346b8b90
        EOF
        
        echo "只创建基础许可证，跳过 TV 许可证"
        ls -la "$USER_LICENSE_DIR/"
        
    - name: 快速验证许可证
      run: |
        echo "=== 验证许可证状态 ==="
        timeout 10 $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || echo "快速验证完成"
        
    - name: 获取依赖
      run: |
        export ANDROID_SDK_ACCEPT_LICENSES=true
        flutter pub get
        
    - name: 构建
      run: |
        echo "=== 构建 APK ==="
        export ANDROID_SDK_ACCEPT_LICENSES=true
        export GRADLE_OPTS="-Dandroid.acceptLicenses=true"
        
        flutter clean
        flutter build apk --debug
        
    - name: 上传结果
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: minimal-build-apk
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 7